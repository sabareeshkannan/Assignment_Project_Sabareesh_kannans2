{% extends "base.html" %}

{% block title %}{{ mealplan.name }}{% endblock %}
{% block page_title %}{{ mealplan.name }}{% endblock %}
{% block page_subtitle %}{{ mealplan.start_date }} to {{ mealplan.end_date }} ¬∑ {{ total_entries }} entries{% endblock %}

{% block content %}
<style>
  .meal-cell{min-height:220px}
  .meal-cell .entries{max-height:120px;overflow:auto}
  .meal-title{display:inline-block;max-width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .meal-line{display:flex;align-items:center;gap:.375rem;min-width:0}
  .meal-line .badge{flex:0 0 auto}
  .meal-line .title{flex:1 1 auto;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .results-box{max-height:240px;overflow:auto;border:1px solid rgba(0,0,0,.1);border-radius:.5rem;padding:.5rem}
</style>

{% url 'mealprepped:mealplan_detail' mealplan.pk as detail_url %}

<section class="mb-4">
  <div class="card">
    <div class="card-body">
      <div class="row g-3 align-items-center">
        <div class="col-12 col-lg-7">
          <div class="small text-muted mb-1">Plan coverage</div>
          <div class="progress" style="height:8px" role="progressbar"
               aria-valuenow="{{ coverage_pct|default:0 }}" aria-valuemin="0" aria-valuemax="100">
            <div class="progress-bar" style="width: {{ coverage_pct|default:0 }}%"></div>
          </div>
          <div class="small text-muted mt-1">
            {{ coverage_pct|default:0 }}% ¬∑ {{ covered_days }}{% if total_days %} / {{ total_days }}{% endif %} days covered
          </div>
        </div>
        <div class="col-12 col-lg-5">
          <div class="d-flex justify-content-lg-end flex-wrap gap-2">
            <a href="{{ detail_url }}" class="btn btn-outline-secondary">Back</a>
            <a href="{{ detail_url }}?add=1#add-panel" class="btn btn-primary">Add entry</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

{% if request.GET.add %}
<section id="add-panel" class="card mb-4 border-0 border-start border-4 border-primary">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h3 class="h6 mb-0">Add from existing recipes</h3>
      <a class="btn btn-sm btn-outline-secondary" href="{{ detail_url }}">Close</a>
    </div>

    <div class="row g-3">
      <div class="col-12 col-xl-4">
        <form method="post" action="{{ detail_url }}" class="card h-100">
          {% csrf_token %}
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label" for="id_date">Date</label>
              <input id="id_date" type="date" name="date" class="form-control"
                     value="{{ prefill_date|default:request.GET.date }}" required>
            </div>

            <div class="mb-3">
              <label class="form-label" for="id_meal_type">Meal type</label>
              <select id="id_meal_type" name="meal_type" class="form-select" required>
                {% for val,label in meal_type_choices %}
                  <option value="{{ val }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>

            <fieldset class="mb-3">
              <legend id="legend-choose-recipe" class="form-label mb-2">Choose recipe</legend>
              <div class="results-box" role="radiogroup" aria-labelledby="legend-choose-recipe">
                {% if recipe_search_results %}
                  {% for r in recipe_search_results %}
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="recipe_id"
                             id="recipe_{{ r.pk }}" value="{{ r.pk }}" required>
                      <label class="form-check-label" for="recipe_{{ r.pk }}">{{ r.title }}</label>
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="text-muted small">Search on the right, then select one here.</div>
                {% endif %}
              </div>
            </fieldset>

            <button type="submit" class="btn btn-primary w-100">Add</button>
          </div>
        </form>
      </div>

      <div class="col-12 col-xl-8">
        <div class="card h-100">
          <div class="card-body">
            <form method="get" action="{{ detail_url }}" class="mb-3">
              <input type="hidden" name="add" value="1">
              {% if prefill_date %}<input type="hidden" name="date" value="{{ prefill_date }}">{% endif %}
              <label class="form-label" for="id_q">Search recipes</label>
              <div class="input-group">
                <span class="input-group-text" aria-hidden="true">üîé</span>
                <input id="id_q" type="text" name="q" value="{{ request.GET.q }}" class="form-control" placeholder="e.g., chicken">
                <button class="btn btn-outline-secondary" type="submit">Search</button>
              </div>
              <div class="form-text">Results appear in the chooser on the left.</div>
            </form>

            {% if recipe_search_results %}
              <div class="small text-muted mb-2">
                {{ recipe_search_results|length }} result{{ recipe_search_results|length|pluralize }}
              </div>
              <ul class="mb-0">
                {% for r in recipe_search_results|slice:":10" %}
                  <li class="mb-1">{{ r.title }}</li>
                {% endfor %}
                {% if recipe_search_results|length > 10 %}
                  <li class="text-muted small mt-1">Showing first 10. Refine your search.</li>
                {% endif %}
              </ul>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endif %}

<div class="row g-4">
  <div class="col-12 col-xl-8">
    {% if weeks %}
      {% for wk in weeks %}
        <div class="mb-3">
          <div class="small text-muted mb-2">
            Week {{ forloop.counter }} ¬∑ {{ wk.start|date:"M j" }} ‚Äì {{ wk.end|date:"M j" }}
          </div>
          <div class="row row-cols-2 row-cols-md-4 row-cols-lg-7 g-3">
            {% for d in wk.days %}
              <div class="col">
                <article class="card meal-cell h-100" id="d-{{ d.date|date:'Y-m-d' }}">
                  <div class="card-body p-2 d-flex flex-column">
                    <div class="d-flex justify-content-between small text-muted">
                      <strong>{{ d.date|date:"D" }}</strong>
                      <span>{{ d.date|date:"M j" }}</span>
                    </div>

                    <ul class="list-unstyled mt-2 mb-2 entries flex-grow-1">
                      {% for e in d.entries %}
                        <li class="mb-1">
                          <div class="meal-line">
                            <span class="badge bg-secondary-subtle text-secondary border">
                              {{ e.get_meal_type_display|default:e.meal_type|capfirst }}
                            </span>
                            {% if e.recipe %}
                              <a href="{% url 'mealprepped:recipe_detail' e.recipe.pk %}"
                                 class="title text-decoration-none">{{ e.recipe.title }}</a>
                            {% else %}
                              <span class="title text-muted">TBD</span>
                            {% endif %}
                          </div>
                        </li>
                      {% empty %}
                        <li class="text-muted small fst-italic">No entries</li>
                      {% endfor %}
                    </ul>

                    <a class="btn btn-sm btn-outline-secondary w-100"
                       href="{{ detail_url }}?add=1&date={{ d.date|date:'Y-m-d' }}#add-panel">
                      Add
                    </a>
                  </div>
                </article>
              </div>
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="alert alert-light text-center text-muted mb-0">
        No date range set for this meal plan.
      </div>
    {% endif %}
  </div>

  <aside class="col-12 col-xl-4">
    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="small text-muted">Entries</div>
            <div class="h5 mb-0">
              <span class="badge bg-primary">{{ total_entries }}</span>
            </div>
          </div>
          <span aria-hidden="true">üìã</span>
        </div>
        <hr>
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="small text-muted">Covered days</div>
            <div class="h5 mb-0">
              <span class="badge bg-success">{{ covered_days }}</span>
            </div>
          </div>
          <span aria-hidden="true">üóìÔ∏è</span>
        </div>
        <hr>
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="small text-muted">Unique recipes</div>
            <div class="h5 mb-0">
              <span class="badge bg-info text-dark">{{ unique_recipes_count }}</span>
            </div>
          </div>
          <span aria-hidden="true">üçΩÔ∏è</span>
        </div>
      </div>
    </div>

    {% if top_recipes %}
      <div class="card mb-3">
        <div class="card-body">
          <div class="small text-muted mb-2">Most used in this plan</div>
          <ul class="list-unstyled mb-0">
            {% for r in top_recipes %}
              <li class="d-flex justify-content-between align-items-center py-1">
                <a href="{% url 'mealprepped:recipe_detail' r.recipe__pk %}">{{ r.recipe__title }}</a>
                <span class="badge rounded-pill bg-light border text-body">{{ r.n }}</span>
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    {% endif %}

    <div class="d-flex gap-2">
      {% if prev_plan %}
        <a class="btn btn-outline-secondary" href="{% url 'mealprepped:mealplan_detail' prev_plan.pk %}">Prev</a>
      {% endif %}
      {% if next_plan %}
        <a class="btn btn-outline-secondary" href="{% url 'mealprepped:mealplan_detail' next_plan.pk %}">Next</a>
      {% endif %}
    </div>
  </aside>
</div>
{% endblock %}
